@@ -2,7 +2,6 @@
  "Comment": "Credit card ML batch pipeline",
  "StartAt": "ExecutionRouter",
  "States": {

    "ExecutionRouter": {
      "Type": "Choice",
      "Choices": [
@@ -29,7 +28,6 @@
      ],
      "Default": "TrainModel"
    },

    "TrainModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sagemaker:createTrainingJob.sync",
@@ -70,13 +68,14 @@
      },
      "Next": "SubmitRegisterModelCommand"
    },

    "SubmitRegisterModelCommand": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": ["i-08d78517733fe6290"],
        "InstanceIds": [
          "i-08d78517733fe6290"
        ],
        "CloudWatchOutputConfig": {
          "CloudWatchLogGroupName": "/aws/ssm/register-model",
          "CloudWatchOutputEnabled": true
@@ -103,13 +102,11 @@
      },
      "Next": "WaitForRegisterModel"
    },

    "WaitForRegisterModel": {
      "Type": "Wait",
      "Seconds": 90,
      "Next": "CheckRegisterModelStatus"
    },

    "CheckRegisterModelStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:getCommandInvocation",
@@ -119,7 +116,6 @@
      },
      "Next": "CheckRegisterModelChoice"
    },

    "CheckRegisterModelChoice": {
      "Type": "Choice",
      "Choices": [
@@ -136,18 +132,18 @@
      ],
      "Default": "FailRegisterModel"
    },

    "FailRegisterModel": {
      "Type": "Fail",
      "Cause": "Register model failed"
    },

    "SubmitSelectChampionCommand": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": ["i-08d78517733fe6290"],
        "InstanceIds": [
          "i-08d78517733fe6290"
        ],
        "CloudWatchOutputConfig": {
          "CloudWatchLogGroupName": "/aws/ssm/select-champion",
          "CloudWatchOutputEnabled": true
@@ -173,13 +169,11 @@
      },
      "Next": "WaitForSelectChampion"
    },

    "WaitForSelectChampion": {
      "Type": "Wait",
      "Seconds": 90,
      "Seconds": 60,
      "Next": "CheckSelectChampionStatus"
    },

    "CheckSelectChampionStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:getCommandInvocation",
@@ -189,7 +183,6 @@
      },
      "Next": "CheckSelectChampionChoice"
    },

    "CheckSelectChampionChoice": {
      "Type": "Choice",
      "Choices": [
@@ -201,44 +194,75 @@
        {
          "Variable": "$.Status",
          "StringEquals": "Success",
          "Next": "BatchInference"
          "Next": "DeleteInferenceModel"
        }
      ],
      "Default": "FailSelectChampion"
    },

    "FailSelectChampion": {
      "Type": "Fail",
      "Cause": "Champion selection failed"
    },

    "DeleteInferenceModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:sagemaker:deleteModel",
      "Parameters": {
        "ModelName": "inference-aws-model"
      },
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "Next": "CreateInferenceModel"
        }
      ],
      "Next": "CreateInferenceModel"
    },
    "CreateInferenceModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:sagemaker:createModel",
      "Parameters": {
        "ModelName": "inference-aws-model",
        "ExecutionRoleArn": "arn:aws:iam::075960506214:role/service-role/AmazonSageMaker-ExecutionRole-20251229T181530",
        "PrimaryContainer": {
          "Image": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3",
          "ModelDataUrl": "s3://mlops-creditcard/prod_codes/inference_aws.tar.gz",
          "Environment": {
            "SAGEMAKER_PROGRAM": "inference.py",
            "SAGEMAKER_SUBMIT_DIRECTORY": "s3://mlops-creditcard/prod_codes/inference_aws.tar.gz"
          }
        }
      },
      "Next": "BatchInference"
    },
    "BatchInference": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sagemaker:createTransformJob.sync",
      "Parameters": {
        "TransformJobName.$": "States.Format('creditcard-batch-inference-{}', States.UUID())",
        "ModelName": "inference-aws-model",
        "TransformInput": {
          "DataSource": {
            "S3DataSource": {
              "S3DataType": "S3Prefix",
              "S3Uri": "s3://mlops-creditcard/prod_inputs/batch_input.csv"
            }
          },
          "ContentType": "text/csv",
          "SplitType": "Line"
        },
        "TransformOutput": {
          "S3OutputPath": "s3://mlops-creditcard/prod_outputs/predictions/",
          "Accept": "text/csv",
          "AssembleWith": "Line"
        },
        "TransformResources": {
          "InstanceType": "ml.m5.large",
          "InstanceCount": 1
        }
      },
      "End": true
    }
  }
