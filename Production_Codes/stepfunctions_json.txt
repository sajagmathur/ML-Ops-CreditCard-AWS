{
  "Comment": "Credit card ML batch pipeline",
  "StartAt": "TrainModel",
  "States": {
    "TrainModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sagemaker:createTrainingJob.sync",
      "Parameters": {
        "TrainingJobName.$": "States.Format('creditcard-training-job-{}', States.UUID())",
        "AlgorithmSpecification": {
          "TrainingImage": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3",
          "TrainingInputMode": "File"
        },
        "RoleArn": "arn:aws:iam::075960506214:role/service-role/AmazonSageMaker-ExecutionRole-20251229T181530",
        "InputDataConfig": [
          {
            "ChannelName": "train",
            "DataSource": {
              "S3DataSource": {
                "S3DataType": "S3Prefix",
                "S3Uri": "s3://mlops-creditcard/data/raw/",
                "S3DataDistributionType": "FullyReplicated"
              }
            }
          }
        ],
        "OutputDataConfig": {
          "S3OutputPath": "s3://mlops-creditcard/prod_outputs/trained_model/"
        },
        "ResourceConfig": {
          "InstanceType": "ml.m5.large",
          "InstanceCount": 1,
          "VolumeSizeInGB": 10
        },
        "StoppingCondition": {
          "MaxRuntimeInSeconds": 3600
        },
        "HyperParameters": {
          "sagemaker_program": "train.py",
          "sagemaker_submit_directory": "s3://mlops-creditcard/prod_codes/source_dir.tar.gz"
        }
      },
      "Next": "SubmitRegisterModelCommand"
    },
    "SubmitRegisterModelCommand": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": [
          "i-08d78517733fe6290"
        ],
        "CloudWatchOutputConfig": {
          "CloudWatchLogGroupName": "/aws/ssm/register-model",
          "CloudWatchOutputEnabled": true
        },
        "Parameters": {
          "commands": [
            "set -e",
            "source /home/ssm-user/mlflow_env/bin/activate",
            "cd /home/ssm-user/mlflow",
            "export MODEL_TAR_S3_URI=s3://mlops-creditcard/prod_outputs/trained_model/",
            "export MLFLOW_TRACKING_URI=sqlite:////home/ssm-user/mlflow/mlflow.db",
            "python register_model.py"
          ]
        }
      },
      "ResultSelector": {
        "CommandId.$": "$.Command.CommandId",
        "InstanceId.$": "$.Command.InstanceIds[0]"
      },
      "Next": "WaitForRegisterModel"
    },
    "WaitForRegisterModel": {
      "Type": "Wait",
      "Seconds": 90,
      "Next": "CheckRegisterModelStatus"
    },
    "CheckRegisterModelStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:getCommandInvocation",
      "Parameters": {
        "CommandId.$": "$.CommandId",
        "InstanceId.$": "$.InstanceId"
      },
      "Next": "CheckRegisterModelChoice"
    },
    "CheckRegisterModelChoice": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.Status",
          "StringEquals": "InProgress",
          "Next": "WaitForRegisterModel"
        },
        {
          "Variable": "$.Status",
          "StringEquals": "Success",
          "Next": "SubmitSelectChampionCommand"
        }
      ],
      "Default": "FailRegisterModel"
    },
    "FailRegisterModel": {
      "Type": "Fail",
      "Cause": "Register model failed"
    },
    "SubmitSelectChampionCommand": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": [
          "i-08d78517733fe6290"
        ],
        "CloudWatchOutputConfig": {
          "CloudWatchLogGroupName": "/aws/ssm/select-champion",
          "CloudWatchOutputEnabled": true
        },
        "Parameters": {
          "commands": [
            "set -e",
            "source /home/ssm-user/mlflow_env/bin/activate",
            "cd /home/ssm-user/mlflow",
            "export MLFLOW_TRACKING_URI=sqlite:////home/ssm-user/mlflow/mlflow.db",
            "python championselection.py"
          ]
        }
      },
      "ResultSelector": {
        "CommandId.$": "$.Command.CommandId",
        "InstanceId.$": "$.Command.InstanceIds[0]"
      },
      "Next": "WaitForSelectChampion"
    },
    "WaitForSelectChampion": {
      "Type": "Wait",
      "Seconds": 90,
      "Next": "CheckSelectChampionStatus"
    },
    "CheckSelectChampionStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:getCommandInvocation",
      "Parameters": {
        "CommandId.$": "$.CommandId",
        "InstanceId.$": "$.InstanceId"
      },
      "Next": "CheckSelectChampionChoice"
    },
    "CheckSelectChampionChoice": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.Status",
          "StringEquals": "InProgress",
          "Next": "WaitForSelectChampion"
        },
        {
          "Variable": "$.Status",
          "StringEquals": "Success",
          "Next": "BatchInference"
        }
      ],
      "Default": "FailSelectChampion"
    },
    "FailSelectChampion": {
      "Type": "Fail",
      "Cause": "Champion selection failed"
    },
    "BatchInference": {
      "Type": "Pass",
      "Result": {
        "status": "batch inference completed"
      },
      "End": true
    }
  }
}
