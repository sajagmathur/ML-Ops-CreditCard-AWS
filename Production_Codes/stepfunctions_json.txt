{
  "Comment": "Credit card ML batch pipeline",
  "StartAt": "TrainModel",
  "States": {
    "TrainModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sagemaker:createTrainingJob.sync",
      "Parameters": {
        "TrainingJobName.$": "States.Format('creditcard-training-job-{}', States.UUID())",
        "AlgorithmSpecification": {
          "TrainingImage": "683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3",
          "TrainingInputMode": "File"
        },
        "RoleArn": "arn:aws:iam::075960506214:role/service-role/AmazonSageMaker-ExecutionRole-20251229T181530",
        "InputDataConfig": [
          {
            "ChannelName": "train",
            "DataSource": {
              "S3DataSource": {
                "S3DataType": "S3Prefix",
                "S3Uri": "s3://mlops-creditcard/data/raw/",
                "S3DataDistributionType": "FullyReplicated"
              }
            }
          }
        ],
        "OutputDataConfig": {
          "S3OutputPath": "s3://mlops-creditcard/prod_outputs/artifacts/trained_model/"
        },
        "ResourceConfig": {
          "InstanceType": "ml.m5.large",
          "InstanceCount": 1,
          "VolumeSizeInGB": 10
        },
        "StoppingCondition": {
          "MaxRuntimeInSeconds": 3600
        },
        "HyperParameters": {
          "sagemaker_program": "train.py",
          "sagemaker_submit_directory": "s3://mlops-creditcard/prod_codes/source_dir.tar.gz"
        }
      },
      "Next": "RegisterModel"
    },
    "RegisterModel": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "TimeoutSeconds": 900,
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": [
          "i-08d78517733fe6290"
        ],
        "Parameters": {
          "commands": [
            "set -e",
            "cd /home/ssm-user/mlflow",
            "source venv/bin/activate || true",
            "export MODEL_TAR_S3_URI=s3://mlops-creditcard/prod_outputs/artifacts/trained_model/",
            "python register_model.py"
          ]
        }
      },
      "Next": "SelectChampion"
    },
    "SelectChampion": {
      "Type": "Pass",
      "Result": {
        "status": "champion selected"
      },
      "Next": "BatchInference"
    },
    "BatchInference": {
      "Type": "Pass",
      "Result": {
        "status": "batch inference completed"
      },
      "End": true
    }
  }
}


Notes: Setup of Step 2: Model Registry on AWS StepFunctions

1. Ensure EC2 has SSM Access: AmazonSSMManagedInstanceCore IAM role
2. Check if ssm agent is running
	1. Enter SSM Agent Setup in AWS CloudShell: aws ssm start-session --target i-08d78517733fe6290
	2. Check SSM Agent is running or not: sudo systemctl status amazon-ssm-agent

Errors Corrected:
1. IAM Permission Issue: 
Option A (recommended first): Attach an inline policy
This avoids affecting other services.
	1. On the role page, click Add permissions
	2. Choose Create inline policy
	3. Click the JSON tab
	4. Delete everything in the editor
	5. Paste this policy:

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowSSMSendCommand",
      "Effect": "Allow",
      "Action": [
        "ssm:SendCommand",
        "ssm:GetCommandInvocation",
        "ssm:ListCommands",
        "ssm:ListCommandInvocations"
      ],
      "Resource": [
        "arn:aws:ec2:us-east-1:075960506214:instance/i-08d78517733fe6290",
        "arn:aws:ssm:us-east-1:075960506214:document/*"
      ]
    }
  ]
}
	1. Click Next
	2. Policy name:

StepFunctions-SSM-SendCommand
	3. Click Create policy
âœ… Permissions are now attached

